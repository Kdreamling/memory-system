from fastapi import FastAPI, Query
from fastapi.responses import HTMLResponse
from supabase import create_client
from datetime import date

app = FastAPI()

SUPABASE_URL = "https://szjzqklanwwkzjzwnalu.supabase.co"
SUPABASE_KEY = "sb_secret_TP4Z2QQYNxXuCJkwB-UQ0A_HxPOB7Ih"
API_TOKEN = "dream_chen_2026"

supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

@app.get("/")
def home():
    return {"status": "晨的助手API运行中~"}

@app.get("/expense", response_class=HTMLResponse)
def add_expense(
    amount: float = Query(..., description="金额"),
    category: str = Query(..., description="分类"),
    note: str = Query(default="", description="备注"),
    token: str = Query(..., description="安全token")
):
    if token != API_TOKEN:
        return "<h1>❌ token错误</h1>"
    
    try:
        supabase.table("claude_expenses").insert({
            "amount": amount,
            "category": category,
            "note": note if note else category,
            "expense_date": str(date.today())
        }).execute()
        
        return f"""
        <html>
        <body style="text-align:center; padding-top:50px; font-family:sans-serif;">
            <h1>✅ 记账成功！</h1>
            <p style="font-size:24px;">{category}：{amount}元</p>
            <p style="color:#666;">已存入数据库~</p>
        </body>
        </html>
        """
    except Exception as e:
        return f"<h1>❌ 出错了：{e}</h1>"
